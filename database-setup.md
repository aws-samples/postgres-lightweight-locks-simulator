# database-setup

* Launch a PostgreSQL database with your favorite tool. We use Amazon Aurora PostgreSQL compatible edition.
We used the db.r5.24xlarge instance for our baseline to allow high conncurrency for reproducing the LWLocks in hyper-scale. However, the tool is not limited to this instance. you will need to modify the loader #inserts and #updates throughput. We also use the postgres schema

* Install your favorite client tool. We use `psql` and execute teh following:  

```
export PGHOST=your-db-endpoint
export PGPASSWORD=mypasswd
```

We run two experiments: The first uses Sequences and the second uses UUID. In either case, the table IDs will be autogenerated, the `create-order-schema-seq.sql` uses the sequences:

```sql
CREATE SEQUENCE order_id_seq START 1;
CREATE SEQUENCE order_pub_id_seq START 1;
CREATE SEQUENCE order_idemp_seq START 1;
CREATE SEQUENCE order_uuid_seq START 1;

CREATE TABLE public.order (
    id bigint DEFAULT nextval('public.order_id_seq'::regclass) PRIMARY KEY,
    public_id bigint DEFAULT nextval('public.order_pub_id_seq'::regclass) NOT NULL,
    idempotency_key bigint DEFAULT nextval('public.order_idemp_seq'::regclass) NOT NULL,
    order_uuid bigint DEFAULT nextval('public.order_uuid_seq'::regclass) NOT NULL,
    ...
);
```
`create-order-schema-uuid.sql` uses the uuid-ossp extention:

```sql
CREATE EXTENSION "uuid-ossp";

CREATE TABLE public.order (
    id uuid DEFAULT uuid_generate_v4() PRIMARY KEY,
    public_id uuid DEFAULT uuid_generate_v4() NOT NULL,
    idempotency_key uuid DEFAULT uuid_generate_v4() NOT NULL,
    order_uuid uuid DEFAULT uuid_generate_v4() NOT NULL,
    ...
);
```
Execute the either of the scripts e.g.,

```
psql -U postgres -f create-order-schema-seq.sql
psql -U postgres -f create-order-schema-uuid.sql
```
We provide two insert scripts, the first `insert-into-order-series.sql` generate series of inserts needed for populating the DB from scratch. The application simulator will use a single insert with `insert-into-order.sql` that returns the pseudo order ID that will be inserted to SQS.

For bulk updates we use function. The input will be the filter recent rows to update, populate a cursor that will update the order rows.

Execute the `create-update-order-function.sql`

```
psql -U postgres -f create-update-order-function.sql
```

To avoid wraparound, run the vaccum.sh every minute using cron or your favorite scheduler. The script will check if previouse vacuum are still running and run a new one only when the previous job ended. 

